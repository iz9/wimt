# AggregateRoot

## Что такое Aggregate Root

Aggregate Root (корень агрегата) — это центральная сущность внутри агрегата, которая управляет целостностью всей группы связанных объектов (entities и value objects).

В DDD:

- Агрегат — это кластер связанных объектов, которые рассматриваются как единое целое.
- Только Aggregate Root может быть напрямую загружена, сохранена или модифицирована через репозиторий.
- Все другие объекты внутри агрегата (Entities, Value Objects) не должны изменяться напрямую извне.

## Зачем нужен Aggregate Root в нашем проекте

В нашем приложении **AggregateRoot** используется для:

1. **Целостности домена**
   - Session агрегат включает в себя сегменты (SessionSegment)
   - Category агрегат управляет своим состоянием
   - Aggregate Root гарантирует, что никто не создаст неконсистентные данные напрямую в сегменте или категории

2. **Сборки Domain Events**
   - Каждое важное событие (SessionStarted, SessionPaused, SessionStopped, CategoryCreated) эмиттится через AggregateRoot
   - AggregateRoot хранит события до момента, когда их забирает Application Layer (через метод `pullDomainEvents()`)

3. **Инварианты**
   - AggregateRoot является единственной точкой проверки правил бизнес-логики внутри агрегата:
     - нет перекрывающихся сегментов
     - сегменты не могут быть меньше минимальной длительности
     - stop завершает сессию окончательно

4. **Интерфейс с репозиториями**
   - Только AggregateRoot может быть сохранена в хранилище (Repository)
   - Все вложенные сущности/объекты изменяются через методы корня агрегата, чтобы сохранять целостность

## Как использовать в нашем проекте

```ts
import { AggregateRoot } from '../aggregate/AggregateRoot';
import { SessionSegment } from './Segment';

class Session extends AggregateRoot {
  private _segments: SessionSegment[] = [];

  start() { ... }       // создает новый сегмент
  pause() { ... }       // завершает активный сегмент
  stop() { ... }        // окончательно завершает сессию

  // Получение доменных событий
  const events = this.pullDomainEvents();
}
```
